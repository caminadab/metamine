<!DOCTYPE html>
<html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
	<title>Taal</title>
</head>
<body>

	<!--
	<div id="intro">
		<a id="vlag" href="{taallink}"><img id="vlag" src="{taalvlag}"></a>
		<h1><i>{welkom}</i></h1>
		<p>
			<i>{kop1}</i></br>
			<i>{kop2}</i>
		</p>
		</div>
	</div>
	-->

<div class="paneel">
	<button id="vorige">‚èÆ</button>
	<button id="speel">‚ñ∂</button>
	<button id="fullscreen">‚á≤</button><!--‚õ∂-->
	<button id="volgende">‚è≠</button>
	<span id="foutmelding"></span>
	<!--<button id="opnieuw">‚ü≤</button>-->
	<!--<button id="info">üõà</button>-->
</div>

<!-- in -->
<div class="in" tabindex="1">
	<textarea id="broncode" name="broncode">{pong}</textarea> 
</div>

<!-- uit! -->
<div id="uit" tabIndex="2" >
</div>

<!--
<div id="wat">
	<h1><i>{overkop}</i></h1>
	<p>{over1}</p>
	<p>{over2}</p>
	<p>{over3}</p>

	<h1><i>{qena}</i></h1>
		<h2>{q1hoe}</h2>
		<p>{a1web}</p>
		<input id="vraag" placeholder="{stelvraag}"></input>
		<br>
		<button id="vraagknop" onclick="fetch('/vraag', {method: 'post', body: document.getElementById('vraag').value}).then(x => {document.getElementById('vraagknop').style.backgroundColor='green'; document.getElementById('vraag').value=''; document.getElementById('vraag').placeholder='{vraagverz}';})">{vraag}</button>
		<div id="qena">
		</div>
	</p>
-->

</body>

<style>

#vlag {
	width: 100px;
	float: right;
	display: inline;
}

#vraag {
	background: black;
	border: none;
	padding: 10px;
	color: white;
	font-size: 24px;
	width: 100%;
}

.paneel {
	clear: both;
	width: 100%;
}

@media (max-width: 800px) {
	.CodeMirror {
		width: 100%;
		display: block;
		height: 200px;
	}
	textarea {
		width: 100%;
	}
	#in {
		width: 100%;
		height: 200px;
		display: inline;
		float: left;
	}
	#uit {
		width: 100%;
		height: 56vh;
		display: inline;
		float: left;
	}
}

#uit {
	font-width: bold;
	background: #3a2299;
	font-size: 48px;
	padding: 12px;
	box-sizing: border-box;
	word-wrap: break-word;
}

#wat {
	clear: both;
	display: block;
}

@media (min-width: 800px) {
	.CodeMirror {
		width: 50%;
		display: inline;
		float: right;
		height: 97vh !important;
	}

	#in {
		height: 97vh;
	}

	textarea {
		width: 50%;
		display: inline;
		float: left;
		height: vh;
	}

	#uit {
		min-height: 97vh;
		width: 50%;
		display: inline;
		float: left;
	}
}

textarea {
	font-size: 16px;
	tab-size: 2;
	-moz-tab-size: 2;
	padding: 3px 4px;
	height: 97vh;
	color: white;
	background: black;
	border: none;
	box-sizing: border-box;
}

.CodeMirror {
	float: left;
	box-sizing: border-box;
}

button {
	background: #012ED4;

	color: white;
	text-decoration: none;
	border: 0;
	width: 25%;
	font-size: 12px;
	height: 3vh;
	display: inline;
	cursor: pointer;
	float: left;

	transition-property: background;
	transition-duration: 0.0s;
}

#vertaal { color: #1b1; }
#volgende, #vorige { color: #bb0; font-size: 72px; }

button:hover {
	background: #0023A1;
	transition-duration: 0.0s;
}

button:active {
	background: #000E42;
}

#laadbalk {
	display: inline;
	float: left;

	background: #000625;
}

#foutmelding {
	opacity: 0;
	display: inline;
	display: none;
	width: 0;
	font-size: 48px;
	margin-left: 20px;
	white-space: nowrap;
	float: left;
	transition: opacity 2.0s linear;
	color: red;
	font-weight: bold;
}

html, body {
	background: #050070;
	color: white;
	font-family: Impace, Charcoal, sans-serif;
	font-size: 16px;
	margin: 0px;
	padding: 0px;
	border: 0px;
}

h1 {
	font-size: 36px;
	margin-left: 80px;
}

p {
	margin-left: 60px;
}

.logo {
	display: inline;
	float: right;
	height: 144px;
	margin: 30px;
}

.bar {
	background: #180D31;
}

.uit {
	background: #1400BC;
}

.volgendeles {
	position: absolute;
	left: -100;
	top: -100;
	font-size: 96px;
	color: darkgreen;
}

canvas {
	background: #000;
	width: 100%;
	height: 100%;
}
.syntaxfout { background: #800; color: #A80; }
.oplosfout { background: #049; color: #AFF; }
.typeerfout { background: #805; color: #FBF; }
.fouticoon { background: #800; color: #F88; }

.loc { cursor: pointer; text-decoration: underline; font-weight: bold; }

#speel0 {
	margin-top: 0.5cm;
	margin-bottom: 0.5cm;
	cursor: pointer;
	font-size: 24px;
	width: 100%;
	/* padding: 10px; */
	/* border: 10px solid black; */
	transition-property: border;
}

@keyframes Knipper {
    0%{background:yellow;color:purple;}
    100%{background:red;color:green;}
}

#speel {
	background: linear-gradient(to right, red, orange, yellow, green, cyan, blue, purple, red);
	background-size: 400% 400%;
	background-repeat: repeat;
	animation: AnimationName 20s linear infinite;
}

@keyframes AnimationName {
    100%{background-position:0% 50%}
    0%{background-position:400% 50%}
}

</style>
<link rel="stylesheet" href="lib/slang.css">
<link rel="stylesheet" href="lib/codemirror.css">

<script src="lib/codemirror.js"></script>
<script src="lib/addon/edit/matchbrackets.js"></script>
<script src="lib/addon/selection/active-line.js"></script>
<script src="lib/taal.js"></script>
<script src="lib/vim.js"></script>
<script>
	
	var demoindex = 0;
	var demos = [
		`{pong}`, `{episch1}`, `{episch2}`,
		`{demo1}`, `{demo2}`, `{demo3}`, `{demo4}`, `{demo5}`,
		`{demo6}`, `{demo7}`, `{demo8}`, `{demo9}`, `{demo10}`,
		`{demo11}`, `{demo12}`, `{demo13}`, `{demo14}`,
		`{demo15}`, `{demo16}`, `{demo17}`, `{demo18}`,
		`{demo19}`, `{demo20}`, `{demo21}`, `{demo22}`,
		`{demo23}`, `{demo24}`, `{demo25}`, `{demo26}`,
		`{demo27}`, `{demo28}`, `{demo29}`, `{demo30}`,
		`{demo31}`, `{demo32}`, `{demo33}`, `{demo34}`,
		`{demo35}`, `{demo36}`, `{demo37}`, `{demo38}`,
		`{demo39}`, `{demo40}`, `{demo41}`,
		// Vyp4l.l.l.lVy
	];
	var speelknop = document.getElementById("speel");
	var fullscreenknop = document.getElementById("fullscreen");
	var vorigeknop = document.getElementById("vorige");
	var volgendeknop = document.getElementById("volgende");
	var cknop = '#012ED4';
	var foutmelding = document.getElementById("foutmelding");
	var laadbalk = document.getElementById("laadbalk");
	var js = document.getElementById("js");

	function vertaal() {
		stop = true; // stop draaiende programma's
		speelknop.style.backgroundColor = '#000E42';

		fetch('/vt', {method: "POST", body: editor.getValue()})
			.then(x => x.json())
			.then(j => {
				onsuccess();
				stop = true;
				setErrors(j.fouten);
				try {
					eval(j.js);

					uit.focus();
				} catch (e) {
					//alert(e + e.stack);
					uit.innerHTML = e + "\n" + e.stack + "\n" + j.js;
					//var genlines = e.stack.match(/\d+/g);
					//alert("GENLINES: "+genlines)
					for (var i = 0; i < Math.min(genlines.length, 3); i++) {
						//alert("GENLINE: " + genlines[i]);
						var bronloc = j.gen2bron[0+genlines[i]];
						alert("BRONLOC: "+JSON.stringify(bronloc));
						// error: {html, loc: {anchor: {line: int } } }
						selecteer(bronloc);
						var fout = { html: e.message, loc: bronloc };
						setErrors([fout]);
					}
					//setErrors({
					uit.innerHTML = "Fout!";
				}
			})
	}

	function stopfunc() {
		stop = true;
	}

	function fullscreen() {
		uit.children[0].requestFullscreen();
	}

	speelknop.addEventListener("mousedown", vertaal);
	fullscreenknop.addEventListener("mousedown", fullscreen);
	volgendeknop.addEventListener("mousedown", function() {
		stop = true;
		setErrors([]);
		demoindex++;
		demoindex = Math.min(demoindex, demos.length-1);
		editor.setValue(demos[demoindex]);
	});
	vorigeknop.addEventListener("mousedown", function() {
		stop = true;
		setErrors([]);
		demoindex--;
		demoindex = Math.max(demoindex, 0);
		editor.setValue(demos[demoindex]);
	});

	function onsuccess() {

		speelknop.innerHTML = '‚ñ∂';
		speelknop.style.background = 'green';
		speelknop.style.transitionDuration = '0.0s';


		foutmelding.style.opacity = "1.0"
		foutmelding.style.color = "green"

		// uitvoer!


		setTimeout(function() {
			speelknop.style.background = cknop;
			foutmelding.style.opacity = "0"
			speelknop.style.transitionDuration = '1.0s';
		}, 100);
	}

	function onerror(e) {
		speelknop.innerHTML = '‚ñ∂';
		speelknop.style.background = 'red';
		speelknop.style.transitionDuration = '0.0s';
		foutmelding.style.color = "red"

		foutmelding.innerHTML = e;
		foutmelding.style.opacity = "1.0"

		setTimeout(function() {
			speelknop.style.background = cknop;
			foutmelding.style.opacity = "0.0"
		}, 5000);
	}

  var editor = CodeMirror.fromTextArea(document.getElementById("broncode"), {
    lineNumbers: false,
    matchBrackets: true,
    mode: "taal",
		indentUnit: 2,
		tabSize: 2,
		indentWithTabs: true,
		theme: 'slang',
		styleActiveLine: true,
		cursorScrollMargin: 10,
		lineWrapping: true,
		height: "1200px",

		extraKeys: {
			"Shift-Enter": function(cm) { vertaal(); },
			"Shift-Esc": function(cm) { cm.setOption('keyMap', 'vim'); },
		},
  });

	//editor.setSize('50%', '300px');
	editor.setValue(demos[demoindex]);

	//editor.setSize(null, '800px');

	// zet de codemirror selectie
	function selecteer(loc) {
		editor.setSelection(loc.anchor, loc.head);
	}

	// jaja!
	var oldWidgets = [];
	var oldLineWidgets = [];

	// error.loc.anchor.line
	// error: {html, loc: {anchor: {line: int } } }
	function setErrors(errors) {

		// verwijder oude
		for (var i = 0; i < oldWidgets.length; i++)
			oldWidgets[i].parentNode.removeChild(oldWidgets[i]);
		oldWidgets = [];

		for (var i = 0; i < oldLineWidgets.length; i++)
			oldLineWidgets[i].clear();
		oldLineWidgets = [];
		
		for (var i = 0; i < errors.length; i++) {
			var error = errors[i];
				var inline = document.createElement("div");
					inline.innerHTML = '<b>&nbsp;<!--‚ö†--></b>';
					inline.classList.add("fouticoon");
					inline.style.fontFamily = 'Verdana';
					inline.style.position = 'absolute';
					inline.style.marginRight = '0px';
					inline.style.marginTop = '-18px';
					//inline.style.zIndex	= '9';
			oldWidgets.push(inline);
			var a = editor.addWidget(error.loc.anchor, inline, {above: true});
				var message = document.createElement("div");
					message.classList.add(error.type+"fout");
					message.classList.add("fout");
					message.innerHTML = error.html;

			var line = error.loc.anchor.line;
			if (line >= editor.lineCount() || line < 0)
				line = 0;
			var b = editor.addLineWidget(line, message);
			oldLineWidgets.push(b);
		}
	}

	// magische symbolen
	var magisch = {
		"*": "¬∑",
		"@": "‚àò",
		"!": "¬¨",
	};
	var bimagisch = {
		"||": "‚Äñ",
		"/0": "‚àÖ",
		"0/": "‚àÖ",
		"o/": "‚àÖ",
		"/o": "‚àÖ",
		"ooo": "‚àû",
		"tau": "œÑ",
		"som": "Œ£",
		"sqrt": "‚àö",
		"->": "‚Üí",
		"-->": "‚Ü¶",
		">=": "‚â•",
		"<=": "‚â§",
		"=<": "‚â§",
		"=/": "‚â†",
		"/=": "‚â†",
		"=>": "‚áí",
		"xx": "√ó",
		"^2": "¬≤",
		"^3": "¬≥",
		"_0": "‚ÇÄ",
		"_1": "‚ÇÅ",
		"_2": "‚ÇÇ",
		"^-1": "‚Åª¬π",
		"RR": "‚Ñù",
		"NN": "‚Ñï",
		"ZZ": "‚Ñ§",
		"BB": "ùîπ",
		"QQ": "‚Ñö",
		"HH": "‚Ñç",
	};
	editor.on("beforeChange", (cm,change) => {
		if (magisch[change.text]) {
			//cm.replaceRange(magisch[change.text], change.from, change.to);
			//return true;
			change.update(change.from,change.to,magisch[change.text]);
		}
		var ch = change.from.ch;
		var line = change.from.line;

		var zin = cm.doc.getLine(line);

		var l2 = zin.substr(Math.max(ch-1, 0), 1) + change.text;
		var l3 = zin.substr(Math.max(ch-2, 0), 2) + change.text;
		var l4 = zin.substr(Math.max(ch-3, 0), 3) + change.text;
		var l5 = zin.substr(Math.max(ch-4, 0), 4) + change.text;
		var l6 = zin.substr(Math.max(ch-5, 0), 5) + change.text;
		var l7 = zin.substr(Math.max(ch-6, 0), 6) + change.text;

		var a;
		var len;
		if (bimagisch[l2]) { len = 2; a = bimagisch[l2]; }
		if (bimagisch[l3]) { len = 3; a = bimagisch[l3]; }
		if (bimagisch[l4]) { len = 4; a = bimagisch[l4]; }
		if (bimagisch[l5]) { len = 5; a = bimagisch[l5]; }
		if (bimagisch[l6]) { len = 6; a = bimagisch[l6]; }
		if (bimagisch[l7]) { len = 7; a = bimagisch[l7]; }
	
		if (a)
		{
			change.update({ch:ch-len+1,line:line}, {ch:change.to.ch,line:change.to.line}, a);
		}
	});

	//var vim = document.getElementById("vim");
	//vim.addEventListener("click", function() { editor.setOption('keyMap', 'vim'); });
	// klik gewoon op Shift+Escape ...


</script>
</html>
