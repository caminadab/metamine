<!DOCTYPE html>
<html>
<meta charset="utf-8">
<h2>Taal 0.1.1</h2>
<i>nu met ontkevering</i>

<p>
	Mooie online code editor met debugger. Typ "<b>-&gt;</b>" om "<b>‚Üí</b>" in te voegen. Druk op &lt;Shift-Enter&gt; om af te spelen.
	
	<button id="vim"><b>Vim-modus</b></button>
	<br> <!-- sorry lui -->
	<button id="c5">Cirkels</button>
	<button id="c1">Welkom</button>
	<button id="c2">Fibonacci</button>
	<button id="c3">Project Euler 1</button>
	<button id="c4">Project Euler 2</button>
	<button id="c5">Cirkels</button>
	<textarea id="broncode" name="broncode">
	</textarea> 
	<button id="tekst"><b>Tekstuitvoer</b></button>
</p>
	<button id="speel" style="color: black;"><b>‚ñ∂‚ñ∂‚ñ∂ Afspelen ‚ñ∂‚ñ∂‚ñ∂</b></button>
	<div id="resultaat">
	</div>

<style>

.syntaxfout { background: #800; color: #A80; }
.oplosfout { background: #049; color: #AFF; }
.typefout { background: #805; color: #FBF; }
.fouticoon { background: #800; color: #F88; }

#speel0 {
	margin-top: 0.5cm;
	margin-bottom: 0.5cm;
	cursor: pointer;
	font-size: 48px;
	width: 100%;
	padding: 10px;
	border: 10px solid black;
	transition-property: border;
}

#speel0:hover {
	border: 10px solid white;
	animation: Knipper 0.05s linear infinite !important;
}

@keyframes Knipper {
    0%{background:yellow;color:purple;}
    100%{background:red;color:green;}
}

#speel {
	background: linear-gradient(to right, red, orange, yellow, green, cyan, blue, purple, red);
	background-size: 400% 400%;
	background-repeat: repeat;
	animation: AnimationName 20s linear infinite;
}

@keyframes AnimationName {
    0%{background-position:0% 50%}
    100%{background-position:400% 50%}
}

</style>
<link rel="stylesheet" href="lib/slang.css">
<link rel="stylesheet" href="lib/codemirror.css">

<script src="lib/codemirror.js"></script>
<script src="lib/addon/edit/matchbrackets.js"></script>
<script src="lib/addon/selection/active-line.js"></script>
<script src="lib/taal.js"></script>
<script src="lib/vim.js"></script>
<script>
	// code tabs
	var c1 = document.getElementById('c1');
	c1.addEventListener("click", function () {
		speelknop.style.display = 'none';
		tekstknop.style.display = 'inline';
		editor.setValue(
`a = 1 + []
uit = tekst a
`);});
	var c2 = document.getElementById('c2');
	c2.addEventListener("click", function () {
		speelknop.style.display = 'none';
		tekstknop.style.display = 'inline';
		editor.setValue(
`fib = n ‚Üí (f‚Åø[0,1])‚ÇÄ
f = [a,b] ‚Üí [b,a+b]
uit = fib 30
`); }
	);
	var c3 = document.getElementById('c3');
	c3.addEventListener("click", function () {
		speelknop.style.display = 'none';
		tekstknop.style.display = 'inline';
		editor.setValue(`goed = i ‚Üí ((i mod 3=0) ‚àß (i mod 5=0))
s = Œ£ ((1 .. 1000) waarvoor goed)
uit = tekst s
; If we list all the natural numbers below 10 that are multiples of 3 or 5, we get 3, 5, 6 and 9. The sum of these multiples is 23.
; Find the sum of all the multiples of 3 or 5 below 1000.
		`); }
	);

	var c4 = document.getElementById('c4');
	c4.addEventListener("click", function() {
		speelknop.style.display = 'none';
		tekstknop.style.display = 'inline';
		editor.setValue(`f = [somA, i, j] ‚Üí (j ‚â§ 4e6 ‚áí [somB, j, i + j])
j mod 2 = 0  ‚áí somB = somA + j
j mod 2 ‚â† 0  ‚áí somB = somA

a = ((herhaal f) [0, 1, 1])‚ÇÄ
uit = tekst(a)

; Each new term in the Fibonacci sequence is generated by adding the previous two terms. By starting with 1 and 2, the first 10 terms will be:

; 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, ...

; By considering the terms in the Fibonacci sequence whose values do not exceed four million, find the sum of the even-valued terms.
`)});

	var cirkelcode = `; dit programma tekent door "tekening" te vullen met vormen
; qua coordinaten: linksonder is (0,0) en rechtsboven is (16/9,1)
; de code hoeft niet gesorteerd te staan
tekening = [ achtergrond, bal, groet ]

; de tekst "Hoi" aan de linkerkant
groet = schrijf(groetpos, "Hoi", wit)
	groetpos = (0, (1 + sin looptijd) / 2)


; een gele cirkel die om het centrum (0.9, 0.5) cirkelt
bal = cirkel(pos, straal, geel)
	pos = (x, y)
		x = 0.9 + 0.5 ¬∑ cos(looptijd)
		y = 0.5 + 0.5 ¬∑ sin(looptijd)
	straal = 0.2

interpoleer = (a,b,n) ‚Üí (n¬∑a‚ÇÄ+m¬∑b‚ÇÄ, n¬∑a‚ÇÅ+b‚ÇÅ¬∑m‚ÇÅ, n¬∑c‚ÇÅ+m¬∑b‚ÇÇ)
	n + m = 1

; maak de achtergrond zwartblauw
achtergrond = rechthoek((0,0), (2,1), achtergrondkleur)
	achtergrondkleur = (0, 0, sin looptijd + 0.5)
`;
	var c5 = document.getElementById('c5');
	c5.addEventListener("click", function() {
		speelknop.style.display = 'inline';
		tekstknop.style.display = 'none';
		editor.setValue(cirkelcode);
	});

  var editor = CodeMirror.fromTextArea(document.getElementById("broncode"), {
    lineNumbers: false,
    matchBrackets: true,
    mode: "taal",
		indentUnit: 2,
		tabSize: 2,
		indentWithTabs: true,
		theme: 'slang',
		styleActiveLine: true,
		cursorScrollMargin: 10,
		lineWrapping: true,
		height: "1200px",
		value: cirkelcode,
		extraKeys: {
			"Shift-Enter": function(cm) { if (speelknop.style.display != 'inline') speelknop.click(); else tekstknop.click(); }
		},
  });
	editor.setValue(cirkelcode);
	editor.setSize(null, '500px');

	// jaja!
	var oldWidgets = [];
	var oldLineWidgets = [];
	function setErrors(errors) {
		editor.setValue(editor.getValue());
		// verwijder oude
		for (var i = 0; i < oldWidgets.length; i++)
			oldWidgets[i].parentNode.removeChild(oldWidgets[i]);
		oldWidgets = [];

		for (var i = 0; i < oldLineWidgets.length; i++)
			oldLineWidgets[i].clear();
		oldLineWidgets = [];
		
		for (var i = 0; i < errors.length; i++) {
			var error = errors[i];
				var inline = document.createElement("div");
					inline.innerHTML = '<b>‚ö†</b>';
					inline.classList.add("fouticoon");
					inline.style.fontFamily = 'Verdana';
					inline.style.position = 'absolute';
					inline.style.marginRight = '0px';
					inline.style.marginTop = '-18px';
					inline.style.zIndex	= '999';
			oldWidgets.push(inline);
			var a = editor.addWidget(error.pos, inline, {above: true});
				var message = document.createElement("div");
					message.classList.add("typefout");
					message.innerHTML = error.waarom;
			var b = editor.addLineWidget(error.pos.line, message);
			oldLineWidgets.push(b);
		}
	}

	// magische symbolen
	var magisch = {
		"*": "¬∑",
		"@": "‚àò",
		"!": "¬¨",
	};
	var bimagisch = {
		"/0": "‚àÖ",
		"0/": "‚àÖ",
		"o/": "‚àÖ",
		"/o": "‚àÖ",
		"oo": "‚àû",
		"tau": "œÑ",
		"som": "Œ£",
		"->": "‚Üí",
		"-->": "‚Ü¶",
		">=": "‚â•",
		"<=": "‚â§",
		"=<": "‚â§",
		"=/": "‚â†",
		"/=": "‚â†",
		"=>": "‚áí",
		"xx": "√ó",
		"^2": "¬≤",
		"^3": "¬≥",
		"_0": "‚ÇÄ",
		"_1": "‚ÇÅ",
		"_2": "‚ÇÇ",
		"^-1": "‚Åª¬π",
		"RR": "‚Ñù",
		"NN": "‚Ñï",
		"ZZ": "‚Ñ§",
		"BB": "ùîπ",
		"QQ": "‚Ñö",
		"HH": "‚Ñç",
	};
	editor.on("beforeChange", (cm,change) => {
		if (magisch[change.text]) {
			//cm.replaceRange(magisch[change.text], change.from, change.to);
			//return true;
			change.update(change.from,change.to,magisch[change.text]);
		}
		var ch = change.from.ch;
		var line = change.from.line;

		var zin = cm.doc.getLine(line);

		var l2 = zin.substr(Math.max(ch-1, 0), 1) + change.text;
		var l3 = zin.substr(Math.max(ch-2, 0), 2) + change.text;
		var l4 = zin.substr(Math.max(ch-3, 0), 3) + change.text;
		var l5 = zin.substr(Math.max(ch-4, 0), 4) + change.text;

		var a;
		var len;
		if (bimagisch[l2]) { len = 2; a = bimagisch[l2]; }
		if (bimagisch[l3]) { len = 3; a = bimagisch[l3]; }
		if (bimagisch[l4]) { len = 4; a = bimagisch[l4]; }
		if (bimagisch[l5]) { len = 5; a = bimagisch[l5]; }
	
		if (a)
		{
			change.update({ch:ch-len+1,line:line}, {ch:change.to.ch,line:change.to.line}, a);
		}
	});

	var vim = document.getElementById("vim");
	vim.addEventListener("click", function() { editor.setOption('keyMap', 'vim'); });

	var resultaat = document.getElementById("resultaat");

	var tekstknop = document.getElementById("tekst");
	tekstknop.style.display = 'none'; // jaja
	tekstknop.addEventListener("click", function() {
		fetch('/vt', {method: "POST", body: editor.getValue()} )
			.then(x => x.text())
			.then(x => resultaat.innerHTML = x);
	});

	var speelknop = document.getElementById("speel");
	// gun de server wat rust...
	var cheatz = `
; niet gluren!
cirkel = c ‚Üí (0, c‚ÇÄ, c‚ÇÅ, c‚ÇÇ)
rechthoek = v ‚Üí (1, v‚ÇÄ, v‚ÇÅ, v‚ÇÇ)
schrijf = t ‚Üí (2, t‚ÇÄ, t‚ÇÅ, t‚ÇÇ)
wit = (1,1,1)
zwart = (0,0,0)
rood = (1,0,0)
groen = (0,1,0)
blauw = (0,0,1)
oranje = (1,0.5,0)
geel = (1,1,0)
paars = (1,0,1) ; lelijk
cyaan = (0,1,1)
uit = "Nee"
`;

	speelknop.addEventListener("click", function() {
		fetch('http://localhost:1237/vt', {method: "POST", body: editor.getValue() + cheatz} )
			.then(x => x.json())
			.then(j => {
				resultaat.innerHTML = j.html;
				setErrors(j.fouten);

				var scripts = Array.prototype.slice.call(resultaat.getElementsByTagName("script"));
				for (var i = 0; i < scripts.length; i++) {
					eval(scripts[i].innerHTML);
				}
			});
	});
</script>
</html>
